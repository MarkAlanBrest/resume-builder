<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Final Resume</title>
  <link rel="stylesheet" href="style.css">

  <style>
    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .template-card {
      border: 2px solid #ccc;
      padding: 12px;
      cursor: pointer;
      text-align: center;
      background: #fff;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 1.1rem;
    }

    .template-card.selected {
      border-color: #0066cc;
      background: #eef5ff;
    }

    #statusMessage {
      display: none;
      margin-top: 15px;
      font-weight: bold;
      color: #0066cc;
    }
  </style>
</head>
<body>

<div class="chat">

  <div class="system">
    Your resume will be generated using the information you provided.
    <br><br>
    <strong>Important:</strong> You must review your resume for accuracy
    before submitting it in Canvas.
  </div>

  <div class="system">Choose a resume style</div>

  <div class="template-grid">
    <div class="template-card selected" data-template="Template"><strong>Classic</strong></div>
    <div class="template-card" data-template="TemplateA"><strong>Modern</strong></div>
    <div class="template-card" data-template="TemplateB"><strong>Sidebar</strong></div>
    <div class="template-card" data-template="TemplateC"><strong>Minimal</strong></div>
  </div>

  <div class="system" style="margin-top:15px;">
    Optional: General comments or requests
  </div>

  <textarea id="generalNotes" style="min-height:80px;"></textarea>

  <label style="display:block; margin-top:15px;">
    <input type="checkbox" id="confirm">
    I understand that I must review my resume before submitting.
  </label>

  <div id="statusMessage">
    Your resume is being generated…
  </div>

  <div style="display:flex; gap:10px; margin-top:15px;">
    <button type="button" onclick="goBack()">Back</button>
    <button type="button" id="finalBtn" disabled>Create Final Resume</button>
  </div>

</div>

<script src="/js/buildResumePayload.js"></script>

<script>
let selectedTemplate = "Template";

document.addEventListener("DOMContentLoaded", () => {
  const confirmBox = document.getElementById("confirm");
  const button = document.getElementById("finalBtn");

  confirmBox.addEventListener("change", () => {
    button.disabled = !confirmBox.checked;
  });

  document.querySelectorAll(".template-card").forEach(card => {
    card.addEventListener("click", () => {
      document.querySelectorAll(".template-card")
        .forEach(c => c.classList.remove("selected"));
      card.classList.add("selected");
      selectedTemplate = card.dataset.template;
    });
  });

  button.addEventListener("click", createResume);
});

function goBack() {
  window.location.href = "education-military.html";
}

async function createResume() {
  const button = document.getElementById("finalBtn");
  const status = document.getElementById("statusMessage");

  button.disabled = true;
  button.textContent = "Generating Resume...";
  status.style.display = "block";

  // Build payload
  const payload = buildResumePayload(
    document.getElementById("generalNotes").value.trim()
  );

  payload.TEMPLATE = selectedTemplate;

  try {
    // ✅ FIXED URL — this now matches your backend route
    const response = await fetch("/api/generateResume", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error("Resume generation failed");
    }

    const blob = await response.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "resume.docx";
    a.click();

    URL.revokeObjectURL(url);
    button.textContent = "Resume Created!";
  } catch (err) {
    console.error(err);
    alert("There was an issue generating your resume.");
    button.disabled = false;
    button.textContent = "Create Final Resume";
    status.style.display = "none";
  }
}
</script>

</body>
</html>
