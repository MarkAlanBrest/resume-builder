var buildResumePayload = function () {

  var generalNotes = "";
  var template = "Template";

  var data = JSON.parse(localStorage.getItem("resumeData")) || {};

  function safe(v) {
    return (v && v !== "undefined") ? v : "";
  }

  function flattenList(arr) {
    if (!Array.isArray(arr)) return "";
    return arr.map(function (item) {
      return "• " + item;
    }).join("\n");
  }

  function flattenJobs(jobs) {
    if (!Array.isArray(jobs)) return "";
    return jobs.map(function (job) {
      var title = safe(job.title);
      var company = safe(job.company);
      var dates = safe(job.dates);

      var duties = "";
      if (Array.isArray(job.duties)) {
        duties = job.duties.map(function (d) {
          return "   - " + d;
        }).join("\n");
      }

      return title + " — " + company + " (" + dates + ")\n" + duties;
    }).join("\n\n");
  }

  function flattenEducation(edu) {
    if (!Array.isArray(edu)) return "";
    return edu.map(function (e) {
      return safe(e.school) + " — " +
             safe(e.degree) + " (" +
             safe(e.year) + ")";
    }).join("\n");
  }

  var LOCATION = [data.city, data.state].filter(function (v) {
    return v;
  }).join(", ");

  return {
    TEMPLATE: template,

    NAME: safe(data.name),
    EMAIL: safe(data.email),
    PHONE: safe(data.phone),
    ADDRESS: safe(data.address),
    LOCATION: LOCATION,

    PROFESSIONAL_SUMMARY: safe(data.objective),
    SKILLS: flattenList(data.quals || []),
    EXPERIENCE: flattenJobs(data.jobs || []),
    EDUCATION: flattenEducation(data.education || []),
    PROGRAM_CERTIFICATIONS: flattenList(data.programCertsSelected || []),
    OUTSIDE_CERTIFICATIONS: safe(data.extraCerts),
    GENERAL_NOTES: safe(generalNotes)
  };
};
